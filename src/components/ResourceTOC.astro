---
/**
 * Renders a navigation menu based on a provided context.
 * @component
 * @example
 * ```astro
 * <ResourceTOC resourceId={resourceId} />
 * <ResourceTOC />
 * ```
 * @property {number} [resourceId] - An object representing the current resource ID.
 * @returns {astro.AstroNode} The rendered navigation menu.
 */

import { Taxonomy, db, eq } from 'astro:db';
import { highlightUrl } from '../utils/urlHelpers';

const { resourceId } = Astro.props;
const activePage = Astro.url.pathname;

const allSectionsQuery = await db.select().from(Taxonomy).where(eq(Taxonomy.type, 1));
const allCategoriesQuery = await db.select().from(Taxonomy).where(eq(Taxonomy.type, 2));
const allSubcategoriesQuery = await db.select().from(Taxonomy).where(eq(Taxonomy.type, 3));

let tocData = allSectionsQuery.map((section) => {
	const onlyCategories = allCategoriesQuery.filter((category) => category.parent === section.id);
	//const subcategories = allSubcategoriesQuery.filter((subcategory) => categories.some((category) => category.id === subcategory.parent));
	const categories = onlyCategories.map((category) => {
		const subcategories = allSubcategoriesQuery.filter((subcategory) => subcategory.parent === category.id);
		return {
			...category,
			subcategories,
		};
	});

	return {
		section,
		categories,
	};
});
---

{resourceId && `<pre>Resource ID: ${resourceId}</pre>`}

<nav class="ListNavigation" transition:name="ListNavigation">
	{
		tocData &&
			tocData.map((item) => {
				return (
					<details
						class:list={highlightUrl(`/${item.section.slug}`, 'ListNavContainer', 'ActiveListNavContainer', activePage)}
						{...(highlightUrl(`/${item.section.slug}`, 'false', 'true', activePage)[1] === 'true' && {
							'aria-expanded': 'true',
							'open': 'open',
						})}
					>
						<summary>
							<h2 class="ListNavTitle" id="treeTitle">
								Categorii de {item.section.title}:
							</h2>
						</summary>
						<div>
							<ol class="ListNav">
								{item.categories &&
									item.categories.map((category) => (
										<li class:list={highlightUrl(`/${item.section.slug}/${category.slug}`, 'ListNavItem', 'ActiveListNav', activePage)}>
											<a class="ListNavLink" href={`/${item.section.slug}/${category.slug}`} title={`Vezi resursele din categoria ${category.title}`}>
												{category.title}
											</a>
											{category.subcategories && (
												<ol class="ListSubNav">
													{category.subcategories.map((subcategory) => (
														<li
															class:list={highlightUrl(
																`/${item.section.slug}/${category.slug}/${subcategory.slug}`,
																'ListSubNavItem',
																'ActiveListNav',
																activePage
															)}
														>
															<a
																class="ListSubNavLink"
																href={`/${item.section.slug}/${category.slug}/${subcategory.slug}`}
																title={`Vezi resursele din subcategoria ${subcategory.title}`}
															>
																{subcategory.title}
															</a>
														</li>
													))}
												</ol>
											)}
										</li>
									))}
							</ol>
						</div>
					</details>
				);
			})
	}
</nav>
